<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Final Term Practical Project Report</title>
</head>
<body>
  <h1>Final Term Practical Project Report</h1>

  <% sciencepracticaldata.forEach((student, index) => { %>
    <h2>Student Name: <%= student._id.name %> | Roll: <%= student._id.roll %></h2>
    <p>Class: <%= student._id.studentClass %> | Section: <%= student._id.section %></p>

    <table border="1" cellspacing="0" cellpadding="5">
      <tr>
        <th rowspan="2">SN</th>
        <th rowspan="2">Unit</th>
        <th colspan="3">Practical</th>
        <th colspan="3">Project</th>
        <th>Remarks</th>
      </tr>
      <tr>
        <th>Total Practical Given</th>
        <th>Total Practical Done</th>
        <th>Obtained Practical Marks</th>
        <th>Total Project Given</th>
        <th>Total Project Done</th>
        <th>Obtained Project Marks</th>
      </tr>

      <% 
        let totalGivenAllPractical = 0;
        let totalDoneAllPractical = 0;
        let totalObtainedAllPractical = 0;
        let totalGivenAllProject = 0;
        let totalDoneAllProject = 0;
        let totalObtainedAllProject = 0;
        let totalUnit = 0;
      %>

      <% lessonData.forEach((lesson) => { %>
       <% lesson.totalLessons.forEach((data)=>{%>
        <% totalUnit += data.units.length; %>
        <% data.units.forEach((unit, uIndex) => { 
          // Practical counts given from syllabus
          const totalPracticalGiven = unit.practicals?.length || 0;
          const totalProjectGiven = unit.projectworks?.length || 0;

          // Student's combined data across ALL terminals
          let combinedPracticals = [];
          let combinedProjects = [];

          student.terminals?.forEach(terminal => {
            const termUnit = terminal.unit?.find(u => u.unitName === unit.unitName);
            if (termUnit) {
              combinedPracticals.push(...(termUnit.practicals || []));
              combinedProjects.push(...(termUnit.projectWorks || []));
            }
          });

          // Practical done & marks
          const totalPracticalDone = combinedPracticals.length;
          const obtainedPracticalMarks = combinedPracticals.reduce((sum, p) => sum + (p.practicalMarks || 0), 0);

          // Project done & marks
          const totalProjectDone = combinedProjects.length;
          const obtainedProjectMarks = combinedProjects.reduce((sum, p) => sum + (p.projectMarks || 0), 0);

          // Update totals
          totalGivenAllPractical += totalPracticalGiven;
          totalDoneAllPractical += totalPracticalDone;
          totalObtainedAllPractical += obtainedPracticalMarks;
          totalGivenAllProject += totalProjectGiven;
          totalDoneAllProject += totalProjectDone;
          totalObtainedAllProject += obtainedProjectMarks;
        %>

        <tr>
          <td><%= uIndex + 1 %></td>
          <td><%= unit.unitName %></td>
          <td><%= totalPracticalGiven %></td>
          <td><%= totalPracticalDone %></td>
          <td><%= ((obtainedPracticalMarks)/20)*20 %></td>
          <td><%= totalProjectGiven %></td>
          <td><%= totalProjectDone %></td>
          <td><%= ((obtainedProjectMarks)/12)*16 %></td>
          <td></td>
        </tr>

        <% }) %>
      <% }) %>

      <!-- Totals -->
      <tr>
        <td></td>
        <td>Total</td>
        <td><%= totalGivenAllPractical %></td>
        <td><%= totalDoneAllPractical %></td>
        <td><%= ((totalObtainedAllPractical)/20)*20 %></td>
        <td><%= totalGivenAllProject %></td>
        <td><%= totalDoneAllProject %></td>
        <td><%= ((totalObtainedAllProject)/12)*16 %></td>
        <td></td>
      </tr>

      <!-- Averages -->
      <tr>
        <td></td>
        <td>Average</td>
        <td></td>
        <td></td>
        <td><%= (((totalObtainedAllPractical)/20)*20) / totalUnit %></td>
        <td></td>
        <td></td>
        <td><%= (((totalObtainedAllProject)/12)*16) / totalUnit %></td>
        <td></td>
      </tr>
    </table>
    <br><br>
    <%})%>
  <% }) %>
</body>
</html>
