<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>English Project Evaluation Form</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #2c3e50;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .form-content {
      padding: 30px;
    }

    .section {
      margin-bottom: 40px;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      overflow: hidden;
    }

    .section-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .section-content {
      padding: 25px;
      background: #f8f9fa;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #495057;
    }

    .form-control {
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-control[readonly] {
      background-color: #e9ecef;
      cursor: not-allowed;
    }

    .table-container {
      overflow-x: auto;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }

    th {
      background: #667eea;
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    tr:hover {
      background-color: #f8f9fa;
    }

    .radio-group {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 8px 0;
      justify-content: center;
    }

    .radio-group input[type="radio"] {
      margin-right: 8px;
      width: 18px;
      height: 18px;
      cursor: pointer;
      transform: scale(1.2);
    }

    .radio-group label {
      margin: 0;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
      color: #2d3748;
      padding: 6px 12px;
      border-radius: 6px;
      transition: all 0.2s ease;
      background: #f0f7ff;
      border: 1px solid #c3dafe;
    }

    .radio-group label:hover {
      background: #e1f0ff;
      border-color: #a3c3ff;
    }

    .radio-group input[type="radio"]:checked + label {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #5a67d8;
    }

    .unit-section {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
    }

    .unit-header {
      background: #495057;
      color: white;
      padding: 15px 20px;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .unit-content {
      padding: 20px;
    }

    .practical-section {
      border: 1px solid #e9ecef;
      border-radius: 8px;
      margin: 15px 0;
      overflow: hidden;
    }

    .practical-header {
      background: #6c757d;
      color: white;
      padding: 10px 15px;
      font-weight: 600;
    }

    .practical-content {
      padding: 15px;
      background: #f8f9fa;
    }

    .project-section {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin: 15px 0;
      overflow: hidden;
    }

    .project-header {
      background: #28a745;
      color: white;
      padding: 10px 15px;
      font-weight: 600;
    }

    .project-content {
      padding: 15px;
    }

    .total-display {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      text-align: center;
    }

    .total-display label {
      font-weight: 600;
      color: #1976d2;
      margin-bottom: 5px;
      display: block;
    }

    .total-display input {
      font-size: 1.2rem;
      font-weight: bold;
      text-align: center;
      border: none;
      background: transparent;
      color: #1976d2;
    }

    .submit-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: block;
      margin: 30px auto;
      min-width: 200px;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }

    /* Enhanced Table Styles */
    .evaluation-table, .table-container table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      border: 2px solid #c3dafe;
    }

    .evaluation-table th, .table-container table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 16px;
      border: 2px solid #5a67d8;
      border-bottom: 2px solid #4c51bf;
    }

    .evaluation-table td, .table-container table td {
      padding: 12px 15px;
      border: 1px solid #c3dafe;
      vertical-align: middle;
      font-size: 15px;
      line-height: 1.6;
      border-right: 1px solid #c3dafe;
    }

    .evaluation-table tr:hover, .table-container table tr:hover {
      background-color: #f0f7ff;
    }

    .evaluation-table tr:nth-child(even), .table-container table tr:nth-child(even) {
      background-color: #fafcff;
    }

    .evaluation-table td:last-child, .table-container table td:last-child {
      border-right: 2px solid #c3dafe;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .container {
        margin: 10px;
        border-radius: 10px;
      }
      
      .header {
        padding: 20px;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .form-content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Nepali Project Evaluation Form</h1>
      <p>Complete evaluation form for practical and project work assessment</p>
    </div>

    <div class="form-content">
      <form action="/practicalprojectform?studentClass=<%= studentClass %>&section=<%= section %>&subject=<%= subject %>&terminal=<%= terminal %>" method="POST">
        
        <!-- Student Information Section -->
        <div class="section">
          <div class="section-header">Student Information</div>
          <div class="section-content">
              <div class="studentname">
            <% studentData.forEach((studentname) => { %>
              <input type="button" name="" id="studentData<%= studentname.roll %>" value="<%= studentname.name %>" style="background-color:#2196f3; color:white; border-radius: 7px; margin:1%; padding:5px; border:none; font-weight: bold; font-size: 16px;" onclick="fill('<%= studentname.roll %>','<%= studentname.name %>','<%= studentname.reg %>')">
            <% }); %>
          </div><input type="hidden" name="reg" >
            <div class="form-row">
              <div class="form-group">
                <label for="roll">Roll Number</label>
                <input type="text" name="roll" id="roll" class="form-control" placeholder="Enter Roll Number" required>
              </div>
              <div class="form-group">
                <label for="name">Student Name</label>
                <input type="text" name="name" id="name" class="form-control" placeholder="Enter Student Name" required>
              </div>
              <div class="form-group">
                <label for="studentClass">Class</label>
                <input type="text" name="studentClass" id="studentClass" class="form-control" value="<%= studentClass %>" readonly>
              </div>
              <div class="form-group">
                <label for="section">Section</label>
                <input type="text" name="section" id="section" class="form-control" value="<%= section %>" readonly>
              </div>
              <div class="form-group">
                <label for="subject">Subject</label>
                <input type="text" name="subject" id="subject" class="form-control" value="<%= subject %>" readonly>
              </div>
              <div class="form-group">
                <label for="terminal">Terminal</label>
                <input type="text" id="terminal" name="terminalName" class="form-control" placeholder="Terminal will be auto-filled" readonly>
              </div>
            </div>
          </div>
        </div>

        <!-- Attendance Section -->
        <div class="section">
          <div class="section-header">Attendance Evaluation</div>
          <div class="section-content">
            <div class="form-row">
              <div class="form-group">
                <label for="attendanceDays">Total Attendance Days</label>
                <input type="number" name="totalAttendance" id="attendanceDays" class="form-control" placeholder="Enter attendance days" oninput="calculateAttendanceMarks()">
              </div>
              <div class="form-group">
                <label for="attendanceMarks">Attendance Marks (Auto-calculated)</label>
                <input type="number" name="attendanceMarks" id="attendanceMarks" class="form-control" readonly step="0.1">
              </div>
            </div>
          </div>
        </div>

        <!-- Participation Section -->
        <div class="section">
          <div class="section-header">Participation Evaluation</div>
          <div class="section-content">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>आधार</th>
                    <th>स्तर</th>
                    <th>विवरण</th>
                    <th>अंक</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td rowspan="4">सक्रियता र सहभागिता</td>
                    <td>सर्वोत्कृष्ट</td>
                    <td>सिकाइमा जिज्ञासा राख्दै, समूह छलफल र अन्तरक्रियामा सक्रियतापूर्वक भाग लिएको</td>
                    <td><div class="radio-group"><input type="radio" name="participationMarks" value="2" id="part2"> <label for="part2">२</label></div></td>
                  </tr>
                  <tr>
                    <td>उत्कृष्ट</td>
                    <td>सिकाइमा जिज्ञासा राख्दै, समूह छलफल र अन्तरक्रियामा कम सक्रियतापूर्वक भाग लिएको</td>
                    <td><div class="radio-group"><input type="radio" name="participationMarks" value="1.5" id="part1_5"> <label for="part1_5">१.५</label></div></td>
                  </tr>
                  <tr>
                    <td>मध्यम</td>
                    <td>सिकाइमा कम जिज्ञासा राख्दै, समूह छलफल र अन्तरक्रियामा निर्देशानुसार भाग लिएको</td>
                    <td><div class="radio-group"><input type="radio" name="participationMarks" value="1" id="part1"> <label for="part1">१</label></div></td>
                  </tr>
                  <tr>
                    <td>सामान्य</td>
                    <td>सिकाइप्रति उदासीन रहेमा, समूह छलफल र अन्तरक्रियामा सक्रियता नदेखाएको</td>
                    <td><div class="radio-group"><input type="radio" name="participationMarks" value="0.5" id="part0_5"> <label for="part0_5">०.५</label></div></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Terminal Marks Section -->
        <div class="section">
          <div class="section-header">Terminal Marks</div>
          <div class="section-content">
            <div class="form-row">
              <div class="form-group">
                <label for="theoryMarks">Terminal Exam Marks</label>
                <input type="number" name="theoryMarks" id="theoryMarks" class="form-control" placeholder="Enter terminal marks" step="0.1" oninput="calculateTerminalMarks()">
              </div>
              <div class="form-group">
                <label for="obtainedconvertedmarks">Converted Marks (Auto-calculated)</label>
                <input type="number" name="terminalMarks" id="obtainedconvertedmarks" class="form-control" readonly step="0.1">
              </div>
            </div>
          </div>
        </div>
        <!-- Practical/Project Work Section -->
        <div class="section">
          <div class="section-header">Listening & Speaking (20)</div>
          <div class="section-content">
            
            <% ScienceData.forEach((item, itemIdx) => { %>
              <% item.units.forEach((unit, idx) => { %>
                <div class="unit-section">
                  <div class="unit-header">
                    Unit: <%= unit.unitName %>
                    <input type="hidden" name="unit[<%= idx %>][unitName]" value="<%= unit.unitName %>">
                  </div>
                  <div class="unit-content">
                    <!-- Practicals and Projects Alternating -->
                    <% unit.practicals.forEach((practical, prindx) => { %>
                      <!-- Practical <%= prindx + 1 %> -->
                      <div class="practical-section">
                        <div class="practical-header">
                          Listening & Speaking <%= prindx + 1 %>: <%= practical %>
                          <input type="hidden" name="unit[<%= idx %>][practicals][<%= prindx %>][practicalName]" value="<%= practical %>">
                        </div>
                        <div class="practical-content">
                          <div class="table-container">
                            <table class="evaluation-table">
                              <thead>
                                <tr>
                                  <th>S.No</th>
                                  <th>मुल्याङ्कनका आधार</th>
                                  <th>परिक्षण पक्ष</th>
                                  <th>सूचक</th>
                                  <th>अंक</th>
                                </tr>
                              </thead>
                              <tbody>
                                <% let iIndex = 0 %>
                                <% practicalFormatData.forEach(function(doc) { %>
                                  <% doc.themes.forEach(function(theme) { %>
                                    <% let themeRowspan = theme.learningOutcome.reduce((sum, lo) => sum + lo.indicators.length, 0); %>
                                    <% let firstThemeRow = true; %>

                                    <% theme.learningOutcome.forEach(function(lo, loIdx) { %>
                                      <% let loRowspan = lo.indicators.length; %>

                                      <% lo.indicators.forEach(function(ind, indIndex) { %>
                                        <tr>
                                          <% if(firstThemeRow && indIndex === 0) { %>
                                            <td rowspan="<%= themeRowspan %>"><%= iIndex+1 %></td>
                                            <td rowspan="<%= themeRowspan %>"><%= theme.themeName %></td>
                                            <% firstThemeRow = false; %>
                                          <% } %>

                                          <% if(indIndex === 0) { %>
                                            <td rowspan="<%= loRowspan %>"><%= lo.learningOutcomeName %></td>
                                          <% } %>

                                          <td><%= ind.indicatorName %></td>
                                          <td>
                                            <div class="radio-group">
                                              <input type="radio" 
                                                     value="<%= ind.indicatorsMarks %>||<%= ind.indicatorName %>||<%= lo.learningOutcomeName %>" 
                                                     class="marks-radio"
                                                     name="unit[<%= idx %>][practicals][<%= prindx %>][criteria][<%= iIndex %>]"
                                                     data-practical="<%= idx %>-<%= prindx %>"
                                                     id="practical_<%= idx %>_<%= prindx %>_<%= iIndex %>_<%= indIndex %>">
                                              <label for="practical_<%= idx %>_<%= prindx %>_<%= iIndex %>_<%= indIndex %>"><%= ind.indicatorsMarks %></label>
                                            </div>
                                          </td>
                                        </tr>
                                      <% }) %>
                                      <% iIndex++ %>
                                    <% }) %>
                                  <% }) %>
                                <% }) %>
                              </tbody>
                            </table>
                          </div>
                          <div class="total-display">
                            <label>Total Practical Marks</label>
                            <input type="number" name="unit[<%= idx %>][practicals][<%= prindx %>][practicalMarks]" 
                                   value="0" id="practical-total-<%= idx %>-<%= prindx %>" 
                                   class="form-control" readonly>
                          </div>
                        </div>
                      </div>

                      <!-- Project Work <%= prindx + 1 %> -->
                      <div class="project-section">
                       Reading and Writing (16) <%= prindx + 1 %>
                          <input type="hidden" name="unit[<%= idx %>][projectWorks][<%= prindx %>][projectName]" value="">
                        </div>
                        <div class="project-content">
                          <div class="table-container">
                            <table>
                              <thead>
                                <tr>
                                  <th>SN</th>
                                  <th>आधार</th>
                                  <th>पक्ष</th>
                                  <th>सूचक</th>
                                  <th>अंक</th>
                                </tr>
                              </thead>
                               <tbody>
                                
                                <% projectFormatData.forEach(function(doc) { %>
                                  <% doc.themes.forEach(function(theme) { %>
                                    <% let themeRowspan = theme.learningOutcome.reduce((sum, lo) => sum + lo.indicators.length, 0); %>
                                    <% let firstThemeRow = true; %>

                                    <% theme.learningOutcome.forEach(function(lo,loIdx) { %>
                                      <% let loRowspan = lo.indicators.length; %>
                                      <% let mulyIndex = iIndex; %>

                                      <% lo.indicators.forEach(function(ind, indIndex) { %>
                                        <tr>
                                          <% if(firstThemeRow && indIndex === 0) { %>
                                            <td rowspan="<%= themeRowspan %>"><%= iIndex+1 %></td>
                                            <td rowspan="<%= themeRowspan %>"><%= theme.themeName %></td>
                                            <% firstThemeRow = false; %>
                                          <% } %>

                                          <% if(indIndex === 0) { %>
                                            <td rowspan="<%= loRowspan %>"><%= lo.learningOutcomeName %></td>
                                          <% } %>

                                          <td><%= ind.indicatorName %></td>
                                          <td>
                                            <div class="radio-group">
                                              
     

                                              <input type="radio" 
                                                     value="<%= ind.indicatorsMarks %>||<%= ind.indicatorName %>||<%= lo.learningOutcomeName %> " 
                                                     class="marks-radio-project"
                                                     name="unit[<%= idx %>][projectWorks][<%= prindx %>][criteria][<%= iIndex %>]"
                                                     data-project="<%= idx %>-<%= prindx %>"
                                                     id="project_<%= idx %>_<%= prindx %>_<%= iIndex %>_<%= indIndex %>">
                                              <label for="project_<%= idx %>_<%= prindx %>_<%= iIndex %>_<%= indIndex %>"><%= ind.indicatorsMarks %></label>
                                            </div>
                                          </td>
                                          <td></td>
                                        </tr>
                                      <% }) %>
                                      <% iIndex++ %>
                                    <% }) %>
                                  <% }) %>
                                <% }) %>
                              </tbody>
                            </table>
                          </div>
                           <div class="total-display">
                            <label>Total Project Marks</label>
                            <input type="number" name="unit[<%= idx %>][projectWorks][<%= prindx %>][projectMarks]" 
                                   value="0" id="project-total-<%= idx %>-<%= prindx %>" 
                                   class="form-control" readonly>
                          </div>
                        </div>
                      </div>
                    <% }) %>
                  </div>
                </div>
              <% }) %>
            <% }) %>
          </div>
        </div>

        <button type="submit" class="submit-btn">Submit Evaluation Form</button>
      </form>
    </div>
  </div>
 



  </form>


<input type="number" value="<%=workingDays%>" id="totalWorkingDays" style="display:none;">





  <script>

    //populating terminal
    const terminal = window.location.search;
    
    const terminalParams = new URLSearchParams(terminal);
    
    const terminalValue = terminalParams.get('terminal');
    document.querySelector('#terminal').value = terminalValue;
function calculateTerminalMarks() {
      const terminal = window.location.search;
    
    const terminalParams = new URLSearchParams(terminal);
    
    const terminalValue = terminalParams.get('terminal');
  
    if(terminalValue != "FINAL")
  {
    const theoryMarks = parseFloat(document.getElementById('theoryMarks').value);
    document.getElementById('obtainedconvertedmarks').value = (( theoryMarks)/50*10).toFixed(2);
  }
}

    function calculateAttendanceMarks() {
     const attendanceDays = parseInt(document.getElementById('attendanceDays').value, 10) || 0;
         const totalWorkingDays = document.getElementById('totalWorkingDays').value || 0;
    
      const attendancePercentage = (attendanceDays / totalWorkingDays) * 100;
      console.log(attendancePercentage);

      if(attendancePercentage >=90 && attendancePercentage <=100) {
        
        document.getElementById('attendanceMarks').value = 2;
      }
      else if(attendancePercentage >= 85 && attendancePercentage < 90) {
      
        document.getElementById('attendanceMarks').value = 1.5;
      }
      else if(attendancePercentage >= 80 && attendancePercentage < 85) {
       
        document.getElementById('attendanceMarks').value = 1;
      }
      else if(attendancePercentage >=75 && attendancePercentage < 80) {
     
        document.getElementById('attendanceMarks').value = 0.5;
      }
      else {
        document.getElementById('attendanceMarks').value = 0;
      }
    }
  </script>
<!-- script to calcualted total obtained per radio per practical -->
 <script>
document.querySelectorAll(".marks-radio").forEach(radio => {
  radio.addEventListener("change", e => {
    let group = e.target.dataset.practical;   // e.g. "0-1"
    let totalInput = document.getElementById("practical-total-" + group);

    // सबै radio जसमा data-practical = यो group छ, र checked
    let checked = document.querySelectorAll(`input[data-practical="${group}"]:checked`);
    let total = Array.from(checked).reduce((sum, r) => sum + parseInt(r.value), 0);

    totalInput.value = total;
  });
});
  </script>
<!-- Project total calculation -->
<script>
document.querySelectorAll(".marks-radio-project").forEach(radio => {
  radio.addEventListener("change", e => {
    let group = e.target.dataset.project;   // e.g. "0-1"
    let totalInput = document.getElementById("project-total-" + group);

    // सबै radio जसमा data-practical = यो group छ, र checked
    let checked = document.querySelectorAll(`input[data-project="${group}"]:checked`);
    let total = Array.from(checked).reduce((sum, r) => sum + parseInt(r.value), 0);

    totalInput.value = total;
  });
});
  </script>



  

<script>
  async function fill(roll,name,reg) {
     const buttons = document.querySelectorAll("[id^='studentData']");
    buttons.forEach(btn => {
        btn.style.backgroundColor = '#2196f3'; // default color
        btn.style.color = 'white';
    });
    const clickedBtn = document.getElementById('studentData' + roll);
    clickedBtn.style.backgroundColor = 'darkblue'; // selected color
    clickedBtn.style.color = 'white';
    document.getElementById('roll').value = roll;
    document.getElementById('name').value = name;
    document.querySelector('input[name="reg"]').value = reg;

    if(roll && name && reg) {
      fillAttendance()
      // Fetch existing data from server
      const response = await fetch(`/getPracticalData?roll=${roll}&reg=${reg}&studentClass=<%= studentClass %>&section=<%= section %>&subject=<%= subject %>&terminal=<%= terminal %>`);
      const practicalData = await response.json();
      console.log("Fetched data:", practicalData);

        if(practicalData.participationMarks) {
          document.querySelector(`input[name="participationMarks"][value="${practicalData.participationMarks}"]`).checked = true;

        } else {
          document.querySelectorAll(`input[name="participationMarks"]`).forEach(radio => radio.checked = false);
        }

      if(practicalData.totalAttendance) {
          document.getElementById('attendanceDays').value = practicalData.totalAttendance || 0;
          calculateAttendanceMarks();

        } else {
          document.getElementById('attendanceDays').value = '';
          document.getElementById('attendanceMarks').value = '';
        }
        if(practicalData.theoryMarks) {
          document.getElementById('theoryMarks').value = practicalData.theoryMarks;
          calculateTerminalMarks();
        } else {
          document.getElementById('theoryMarks').value = '';
          document.getElementById('obtainedconvertedmarks').value = '';
        }
        // Populate practical marks
        if(practicalData.unit && Array.isArray(practicalData.unit)) {
          practicalData.unit.forEach((unit, unitIdx) => {
            // Populate practical marks
            if(unit.practicals && Array.isArray(unit.practicals)) {
              unit.practicals.forEach((practical, practicalIdx) => {
              // ...existing code...
if (practical.criteria && Array.isArray(practical.criteria)) {
  // Get all radios for this practical
  let allRadios = document.querySelectorAll(`input[data-practical="${unitIdx}-${practicalIdx}"]`);
  
  // Group radios by their name attribute
  let radioGroups = {};
  allRadios.forEach(radio => {
    if (!radioGroups[radio.name]) {
      radioGroups[radio.name] = [];
    }
    radioGroups[radio.name].push(radio);
  });
  
  // Match criteria with radio groups (assuming they are in the same order)
  let groupNames = Object.keys(radioGroups);
  practical.criteria.forEach((c, criteriaIdx) => {
    if (criteriaIdx < groupNames.length) {
      let mark = c.practicalIndicatorMarks.toString().trim();
      let radiosInGroup = radioGroups[groupNames[criteriaIdx]];
      
      // Find and check the matching radio in this group
      let matchingRadio = radiosInGroup.find(radio => 
        radio.value.split('||')[0].trim() === mark
      );
      
      if (matchingRadio) {
        matchingRadio.checked = true;
      }
    }
  });
}
// ...existing code...


                // Update total for this practical
                let totalInput = document.getElementById(`practical-total-${unitIdx}-${practicalIdx}`);
                let checked = document.querySelectorAll(`input[data-practical="${unitIdx}-${practicalIdx}"]:checked`);
                let total = Array.from(checked).reduce((sum, r) => sum + parseInt(r.value), 0);
                totalInput.value = total;
              });
            }

            // Populate project marks
            // Populate project marks
// ...existing code...
if(unit.projectWorks && Array.isArray(unit.projectWorks)) {
  unit.projectWorks.forEach((project, projectIdx) => {
    if (project.criteria && Array.isArray(project.criteria)) {
      // Get all radios for this project
      let allRadios = document.querySelectorAll(`input[data-project="${unitIdx}-${projectIdx}"]`);
      
      // Group radios by their name attribute
      let radioGroups = {};
      allRadios.forEach(radio => {
        if (!radioGroups[radio.name]) {
          radioGroups[radio.name] = [];
        }
        radioGroups[radio.name].push(radio);
      });
      
      // Match criteria with radio groups (in order)
      let groupNames = Object.keys(radioGroups);
      project.criteria.forEach((c, criteriaIdx) => {
        if (criteriaIdx < groupNames.length) {
          let mark = c.projectIndicatorMarks.toString().trim();
          let radiosInGroup = radioGroups[groupNames[criteriaIdx]];
          
          // Find and check the matching radio in this specific group
          let matchingRadio = radiosInGroup.find(radio => 
            radio.value.split('||')[0].trim() === mark
          );
          
          if (matchingRadio) {
            matchingRadio.checked = true;
          }
        }
      });
    }

    // Update total
    let totalInput = document.getElementById(`project-total-${unitIdx}-${projectIdx}`);
    let checked = document.querySelectorAll(`input[data-project="${unitIdx}-${projectIdx}"]:checked`);
    let total = Array.from(checked).reduce((sum, r) => sum + parseInt(r.value), 0);
    totalInput.value = total;
  });
}
// ...existing code...
          });
        }
      } else {
        // Clear form if no data
        document.getElementById('attendanceDays').value = '';
        document.getElementById('attendanceMarks').value = '';
        document.getElementById('theoryMarks').value = '';
        document.getElementById('obtainedconvertedmarks').value = '';

        // Clear practical marks
        ScienceData.forEach((item) => {
  item.units.forEach((unit,unitIdx)=> {
    // Clear practicals
    unit.practicals.forEach((practical,practicalIdx)=> {
      document.getElementById(`practical-total-${unitIdx}-${practicalIdx}`).value = '0';
      document.querySelectorAll(`input[data-practical="${unitIdx}-${practicalIdx}"]`).forEach(radio => {
        radio.checked = false;
      });
    });

    // Clear projects
    unit.projectWorks.forEach((project, projectIdx) => {
      document.getElementById(`project-total-${unitIdx}-${projectIdx}`).value = '0';
      document.querySelectorAll(`input[data-project="${unitIdx}-${projectIdx}"]`).forEach(radio => {
        radio.checked = false;
      });
    });
  });
});

      }
    }
  
</script>

<input type="text" id="attendanceData" value='<%= JSON.stringify(attendanceData) %>' style="display:none;">
<input type="text" id="marksheetSetting" value="<%=JSON.stringify(marksheetSetting)%>" style="display:none;">
<script>

  function fillAttendance()
  {
  const roll = document.getElementById('roll').value;
  const name = document.getElementById('name').value;
  const attendanceData = JSON.parse(document.getElementById('attendanceData').value);
  const marksheetSetting = JSON.parse(document.getElementById('marksheetSetting').value);
  const terminalname = document.getElementById('terminal').value;
  console.log("Attendance Data on load:", attendanceData);
  if(roll && name) {
    attendanceData.forEach(record => {
      if(record.roll === roll.toString()) {
        if(terminalname===marksheetSetting[0].terminals[0].name)
      {
        document.getElementById('attendanceDays').value = record.firstTerm || 0;
        calculateAttendanceMarks();
      }
      else if (terminalname===marksheetSetting[0].terminals[1].name) {
        document.getElementById('attendanceDays').value = record.secondTerm || 0;
        calculateAttendanceMarks();
      }
        else if (terminalname===marksheetSetting[0].terminals[2].name) {
        document.getElementById('attendanceDays').value = record.thirdTerm || 0;
        calculateAttendanceMarks();
        }
        else if (terminalname===marksheetSetting[0].terminals[3].name) {
        document.getElementById('attendanceDays').value = record.finalTerm || 0;
        calculateAttendanceMarks();
        }
      }
    });

  }
  }
  
</script>
<script>
  const ScienceData = <%- JSON.stringify(ScienceData) %>;

function clearForm() {
  // Clear text/number inputs
 
  document.getElementById('theoryMarks').value = '';
  document.getElementById('obtainedconvertedmarks').value = '';

  // ✅ Uncheck all radios properly
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.checked = false;
  });

  // (Optional) Reset practical/project totals if you have them
  document.querySelectorAll('[id^="practical-total-"]').forEach(el => el.value = '0');
  document.querySelectorAll('[id^="project-total-"]').forEach(el => el.value = '0');

  console.log("Form cleared.");
}

</script>
</body>
</html>
