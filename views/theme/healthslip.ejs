<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Practical Project Record</title>
</head>
<body>
  <h1>Practical Project Slip</h1>

  <form action="/practicalslipsave?studentClass=<%= studentClass %>&section=<%= section %>&subject=<%= subject %>&terminal=<%= terminal %>&academicYear=<%= marksheetSetting[0].academicYear %>" method="POST">

    <table border="1" cellspacing="0" cellpadding="5">
      <tr>
        <th>Roll</th>
        <th>Name</th>
        <th>Class</th>
        <th>Section</th>
        <th>Attendance & Participation (4)</th>
        <th>Project Work & Practical Work (36)</th>
        <th>Terminal Exam Marks (10)</th>
        <th>Total (50)</th>
        <th>Grade</th>
      </tr>

      <% sciencepracticaldata.forEach((student, index) => { %>
        <% 
          // Attendance + Participation
          const attendanceParticipation = (student.attendanceMarks || 0) + (student.participationMarks || 0);

          // Portion-wise averages
          let portionWise = {};
          student.unit.forEach(u => {
            if (!portionWise[u.portion]) portionWise[u.portion] = [];
            u.projectWorks.forEach(p => portionWise[u.portion].push(p.projectMarks || 0));
          });

          let projectTotal = 0;
          for (let portion in portionWise) {
            if (portionWise[portion].length > 0) {
              let avg = portionWise[portion].reduce((a, b) => a + b, 0) / portionWise[portion].length;
              projectTotal += avg;
            }
          }

          // Scale to 36 marks
          const practicalProjectMarks = projectTotal; 

          // Terminal
          const terminalMarks = student.terminalMarks || 0;

          // Final total
          const totalMarks = attendanceParticipation + practicalProjectMarks + terminalMarks;

          // Percentage for grade
          const percentage = (totalMarks / 50) * 100;
          let grade = "";
          if (percentage >= 90) grade = "A+";
          else if (percentage >= 85) grade = "A";
          else if (percentage >= 80) grade = "B+";
          else if (percentage >= 70) grade = "B";
          else if (percentage >= 60) grade = "C+";
          else if (percentage >= 50) grade = "C";
          else if (percentage >= 40) grade = "D";
          else grade = "NG";
        %>

        <tr>
          <td><%= student.roll %></td>
          <td><%= student.name %></td>
          <td><%= student.studentClass %></td>
          <td><%= student.section %></td>
          <td><%= attendanceParticipation %></td>
          <td><%= practicalProjectMarks %></td>
          <td><%= terminalMarks %></td>
          <td><%= totalMarks %></td>
          <td><%= grade %></td>
        </tr>

        <!-- Hidden inputs for saving -->
        <input type="hidden" name="slip[<%= index %>][roll]" value="<%= student.roll %>">
        <input type="hidden" name="slip[<%= index %>][name]" value="<%= student.name %>">
        <input type="hidden" name="slip[<%= index %>][studentClass]" value="<%= student.studentClass %>">
        <input type="hidden" name="slip[<%= index %>][section]" value="<%= student.section %>">
        <input type="hidden" name="slip[<%= index %>][attendanceParticipation]" value="<%= attendanceParticipation %>">
        <input type="hidden" name="slip[<%= index %>][practicalProject]" value="<%= practicalProjectMarks %>">
        <input type="hidden" name="slip[<%= index %>][terminal]" value="<%= terminalMarks %>">
        <input type="hidden" name="slip[<%= index %>][total]" value="<%= totalMarks %>">
        <input type="hidden" name="slip[<%= index %>][grade]" value="<%= grade %>">

      <% }) %>
    </table>

    <br>
    <input type="submit" value="Save Slip">
  </form>
</body>
</html>
